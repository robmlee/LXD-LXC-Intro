# Install LXD-LXC

---
## 一、安裝 LXD
- 適用 OS: Ubuntu 18.04 以上等版本(Debian 等多種 GNU/Linux 皆適用)
- 建議 OS: Ubuntu 22.04 LTS
  - x86/x64, arm64 皆可用安裝。
  - 但不同 CPU 架構所建立的 LXC Container，無法互用。
- 硬體建議：  
  - CPU: 至少 Intel i5-4xxx, Armv8-A (即 RPi 4B 所用)
  - RAM: 至少 4GB RAM (越多越好)
  - HDD/SSD: 至少 256 GB (越多越好)

----
### 1. 安裝 LXD
  ```bash=
  ## Update system
  sudo apt update; sudo apt upgrade -y

  ## Install lxd the LTS stable version
  sudo snap install lxd --channel=5.21/stable
  ```

----
### 2. 初始化 LXD
- **2-1. LXD 初始化設定**
  ```bash=
  ## Set up the LXD server
  #sudo lxd init ## <--- 舊版 Ubuntu 用法

  ## Set up the LXD server (Ubuntu 22.04 版之後 or Debian 用法)
  lxd init
  ```

  ```text=
  Would you like to use LXD clustering? (yes/no) [default=no]: [Enter]
  Do you want to configure a new storage pool? (yes/no) [default=yes]: [Enter]
  Name of the new storage pool [default=default]: [Enter]
  Name of the storage backend to use (dir, lvm, zfs, ceph, btrfs) [default=zfs]: [Enter]
  Create a new ZFS pool? (yes/no) [default=yes]: [Enter]
  Would you like to use an existing empty block device (e.g. a disk or partition)? (yes/no) [default=no]: [Enter]
  Size in GiB of the new loop device (1GiB minimum) [default=30GiB]: 32GiB  ## <--- 一般使用硬碟剩餘空間的 1/3 到 1/2
  Would you like to connect to a MAAS server? (yes/no) [default=no]: [Enter]
  Would you like to create a new local network bridge? (yes/no) [default=yes]: [Enter]
  What should the new bridge be called? [default=lxdbr0]: [Enter]
  What IPv4 address should be used? (CIDR subnet notation, “auto” or “none”) [default=auto]: [Enter]
  What IPv6 address should be used? (CIDR subnet notation, “auto” or “none”) [default=auto]: none
  Would you like the LXD server to be available over the network? (yes/no) [default=no]: [Enter]
  Would you like stale cached images to be updated automatically? (yes/no) [default=yes]: [Enter]
  Would you like a YAML "lxd init" preseed to be printed? (yes/no) [default=no]: [Enter]
  ```

- **2-2. 匯出 init 的初始化設定**
  ```bash=
  sudo lxd init --dump > lxdinitdump.yaml
  ```
  
---
## 二、使用 LXC Container/VM

### 1. 建立 LXC Container/VM
- **1-1. 建立指令，以 Ubuntu 為例：** 
  ```bash=
  ## for Container
  ## 格式：lxc launch [distro]:[version] [Container Name]
  lxc launch ubuntu:22.04 ub2204

  ## for VM
  lxc launch ubuntu:22.04 --vm ub2204-vm
  ```

- **1-2. 查看 Container/VM：**   
  ```bash=
  ## 
  lxc list  # or lxc ls 
  ```

### 2. 登入/登出 Container/VM
- **2-1. 登入 Container/VM：**   
  ```bash=
  ## 以 ubuntu 這個帳號登入
  lxc exec ub2204 -- sudo --login --user ubuntu

  ## or 以 root 這個帳號登入
  lxc exec ub2204 -- bash
  ```

- **2-2. 登出 Container/VM：**   
  ```bash=
  ## 登出
  exit
  ```

### 3. 更改 Container/VM 時區設定
  ```bash=
  ## 更改時區為 taipei。
  lxc exec ub2204 -- sudo timedatectl set-timezone Asia/Taipei
  
  ## 檢視時區
  lxc exec ub2204 -- sudo timedatectl
  ```
  
### 4. 管理 Container 
- **4-1. 啟動/關閉/重啟 Container/VM**
  ```bash=
  ## 啟動/關閉/重啟
  lxc [start/stop/restart] ub2204
  ```
  
- **4-2. 查看 Container/VM 狀態**
  ```bash=
  ## 查看 Container 狀態
  lxc info ub2204
  ```
  
- **4-3. 更名/拷貝 Container/VM**
  ```bash=
  ## 建議最好先關閉
  lxc stop ub2204
  
  ## 更名/拷貝
  lxc [rename/copy] ub2204
  ```
  
- **4-4. 刪除 Container/VM**
  ```bash=
  ## 需先關閉，才能刪除
  lxc stop ub2204
  
  ## 刪除
  lxc [start/stop/restart] ub2204
  ```

- **4-5. 快照 Snapshot 的建立/查看/回覆/移除**
  **建立 Snapshot**
  ```bash=
  ## 格式：lxc snapshot {container} {snapshot-name} [--stateful]
  lxc snapshot ub2204 
  ```

  **查看 Snapshot**
  ```bash=
  ## 查看 snapshot
  lxc info ub2204
  ```

  **回覆 Snapshot**
  ```bash=
  ## 查看 snapshot
  lxc restore ub2204 {snapshot-name}
  ```

  **移除 Snapshot**
  ```bash=
  ## 一般刪除型
  lxc delete/rm {container}/{snapshot-name}
  
  ## 強制刪除型
  lxc delete {container}/{snapshot-name} -i
  ```

### 5. lxc help 指令 
  ```bash=
  lxc --help
  lxc {command} --help
  lxc list --help
  ```

---
## 三、Host 與 Container/VM 間的檔案傳輸
- **1. Pull a file from container/VM**
  ```bash=
  ## 格式：lxc file pull {continer-nane}/{path/to/file} {/path/to/host/dest}
  lxc file pull ub2204/var/www/nginx/app/config.php .
  ```
 
- **2. Push a file to container/VM**
  ```bash=
  ## 格式：lxc file push {/host/path/to/file} {continer-nane}/path/to/dest/dir/
  lxc file push config.php ub2204/var/www/nginx/app/
  ```

---
## 四、備份/還原 Container/VM

### 1. 備份 Container/VM
- **1-1. 利用 export 指令備份方法**
  ```bash=
  # 停止 Container: ub2204
  lxc stop ub2204
  
  # 利用 export 指令備份 Container
  lxc export ub2204 ub2204_`date -I`.tar.bz2 --compression bzip2
  
  # 將 ub2204.tar.gz scp 到主機 192.168.1.4 的 tom 帳號目錄下
  scp ub2204.tar.gz tom@192.168.1.4:/home/tom/
  ```

### 2. 還原 Container/VM
- **1-1. 利用 import 指令匯入 Container**

  ```bash=
  # 從主機 tom@192.168.1.4 cp ub2204.tar.gz 過來
  scp tom@192.168.1.4:/home/tom/ub2204.tar.gz 
  
  # 利用 import 指令匯入 Container
  lxc import ub2204.tar.bz2 
  
  # 查看 Container
  lxc ls
  
  # 啟動 focal 試試看
  lxc start ub2204
  ```





